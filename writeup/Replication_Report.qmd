---
title: "Replication of Experiment 2 in Lake et al. (2019, CogSci)"
author: "Daniel Wurgaft (wurgaft@stanford.edu)"
date: "`r format(Sys.time(), '%B %d, %Y')`"
format:
  html:
    toc: true
---

## Introduction

### Choice of Experiment

Lake et al. (2019) investigated how humans learn novel concepts and generalize compositionally. To do so, they used a task in which participants must learn mappings between instructions written in a simple pseudo-language and sequences of symbols. I chose to replicate experiment 2 from the study, as that experiment provided insight into three inductive biases that guide human generalizations. This experiment is highly relevant for my work, as I study the computational basis of concept learning and generalization in humans and ML models, and one of my central interests is understanding what inductive biases allow humans to learn from sparse data and generalize systematically.

### Description of Experiment

The experiment tested the influence of three inductive biases on human generalizations: 

1) Mutual Exclusivity (ME): the tendency to associate a novel name with a novel object rather than an object that is already familiar by a different name. 

2) One-to-one mappings: the tendency to map a single input symbol to a single output symbol. 

3) Iconic concatenation: the tendency to concatenate output symbols in the order they were provided in the input. 

To study these biases, participants were provided with mappings between instructions and colored circles. They were then provided with a test instruction and asked to answer with its corresponding output sequence of colored circles.

### Challenges

Some of the possible challenges for this project include: Programming the experiment interface and randomizing the word-circle mappings in each trial, and replicating the trial sequence as accurately as possible.

### Links to Repository and Original Paper

[Link to the repository](https://github.com/psych251/lake2019/tree/main)

[Link to original paper](https://github.com/psych251/lake2019/blob/main/original_paper/1901.04587.pdf)


## Methods


### Planned Sample

Given that the original experiment had only 28 participants and the experiment is relatively short, a sample size of 2.5 times the original sample can be recruited. Hence, the planned sample size will be 70 participants. 

### Materials

Stimuli and instructions followed those of the original paper:

> "Participants were informed that
the study investigated how people learn input-output associations, and that they would be asked to learn a set of commands
and their corresponding outputs... the pseudoword and colors were re-randomized for each trial from a larger set of 20 possible pseudowords and 8 colors. To
emphasize the inductive nature of the task, participants were
told that there were multiple reasonable answers for a given
trial and were instructed to provide a reasonable guess."


### Procedure

The procedure followed precisely that of the original paper: 

> "14 independent trials
that evaluated biases under different circumstances. Each trial
provided a set of study instructions (input-output mappings)
and asked participants to make a judgment about a single new
test instruction... The trials were structured as follows. Six trials pertain
to ME and whether participants are sensitive to counterevidence and the number of options in the response pool... Three trials pertain to iconic concatenation and how participants concatenate
instructions together in the absence of demonstrations... Three additional trials pertain to how
people weigh ME versus one-to-one in judgments that necessarily violate one of these biases... Finally, two catch trials queried a test instruction that was identical to a study instruction."

The study and test instructions used for each trial described above adhered to the structure provided under "Additional nuance in inductive biases" in the [data release](https://cims.nyu.edu/~brenden/supplemental/BIML-supp-results/sysgen.html) for lake et al. (2023), which uses the same human data as Lake et al. (2019).


### Analysis Plan

Screening criteria used to determine eligibility for participation in the study included: more than 10 previous submissions and above 95% approval rate on Prolific, fluency in English (given that the task was provided in English), and answering "No, I have no issues seeing colours" to the Prolific screening question "Do you experience colourblindness?" (given that distinguishing between colors is a crucial part of the task).

As in the original study, participants were excluded from the analysis if they answered incorrectly on one or more catch trials.

**Key analysis of interest:** A logistic mixed model was fit to data from mutual exclusivity trials, with number of counter examples (different pseudowords matched to the same color) and pool size as fixed effects, and response consistency with mutual exclusivity (defined as any sequence that is not similar to the colored circle provided in the study instructions) as the response variable.  

As in the original paper, consistency with iconic concatenation across the three trials testing it was computed, as well as number of choices consistent with one-to-one mappings over mutual exclusivity in the three trials contrasting these biases.

Exploratory analyses: As in the original paper, percentage of agreement with ME in the no counter evidence, pool size = 2 trial (simplest ME condition) will be examined both when ME is defined as a single circle of another color, and when it is defined as any sequence not similar to the colored circle provided in the study instructions.

### Differences from Original Study

Whereas in the original study circles could be added to the response array by clicking or dragging, in this version, circles could only be added to the response array by clicking. The interface of the original study also allowed participants to rearrange circles inside the response array or clear the array with a reset button, whereas in this version participants could use a delete button or a reset button. Additionally, circle colors do not match the colors used in the original paper, yet no particular control for the colors used was mentioned in the original study, and the task is intentionally designed such that color-pseudoword assignments are arbitrary (given that they are re-randomized in each trial), hence this difference is unlikely to impact the final results.

Finally, there were also several differences related to data collection: In the original experiment, data was collected using Mechanical Turk and psiTurk, and participants were only recruited from the United States. In this version, data was collected using Prolific, and participants were not screened for eligibility based on country, but based on fluency in English, previous number of submissions and approval rating on Prolific (as detailed above), and reporting no colorblindness.


<!-- #### Actual Sample -->

<!-- Sample size, demographics, data exclusions based on rules spelled out in analysis plan -->

<!-- #### Differences from pre-data collection methods plan -->

<!-- Any differences from what was described as the original plan, or "none". -->

## Results (Only pilot results so far)

### Data preparation

Data preparation following the analysis plan.

```{r, include=TRUE, message=FALSE}
#### Load Relevant Libraries and Functions
library(here)
library(lme4)
library(tidyverse)

#### Import data
df_raw <- read_csv(here("data/pilot/learning-instructions-pilot-anon.csv"))

#### Data exclusion / filtering
df_catch = df_raw %>% filter(type == "catch trial") %>% 
                      filter(pass == FALSE) 

df_proc <- df_raw %>% 
            # exclude participants who failed a catch trial
            filter(!(pid %in% unique(df_catch$pid))) 

#### Prepare data for analysis

# Make a dataframe for each trial type

## Mutual exclusivity trials
df_ME = df_proc %>% filter(type=="ME trial") %>% mutate(follows_ME = case_when(
  .$example_color == .$response ~ 0,
  .$example_color != .$response ~ 1,
  .default = NA),
  follows_ME_simple_definition = case_when(
    .$example_color != .$response & nchar(.$response) == 1 ~ 1,
    .default = 0
  )) %>% select(c(pid, response, example_color, pool_size, num_counters, follows_ME, follows_ME_simple_definition))  


## iconic concatenation trials
df_concat = df_proc %>% filter(grepl("concat trial", type)) %>% mutate(follows_iconicConcat = case_when(
  (.$type == "simple concat trial" & .$response == paste0(.$example1_color,  .$example2_color)) ~ 1,
    (.$type == "doubleInTest concat trial" & .$response == paste0(.$example2_color, .$example1_color,  .$example1_color)) ~ 1,
  (.$type == "multipleCircles concat trial" & .$response == paste0(.$example1_color, .$example1_color, .$example1_color,  .$example2_color,  .$example2_color)) ~ 1,
  .default = 0
)) %>% select(pid, type, target, examples, response, follows_iconicConcat)

## ME vs. one to one trials
df_ME_vs_OneToOne = df_proc %>% filter(grepl("ME_vs_OneToOne trial", type)) %>%
  mutate(follows_1to1 = case_when(
  sapply(strsplit(.$target, " "), length) == nchar(.$response) ~ 1,
  .default = 0)) %>% select( pid, type, target, examples, response, follows_1to1, type)
```

### Confirmatory analysis

#### Mutual Exclusivity: 

##### Main figure:

```{r, include=TRUE, message=FALSE}
df_ME_summarized = df_ME %>% group_by(pool_size, num_counters) %>% summarize(percent_follows_ME = mean(follows_ME)*100,
                                                                             percent_se = sd(follows_ME)*100 / length(follows_ME))

group.colors <- c("2" = "#666BFF", "6" = "#F8766D")

ggplot(data = df_ME_summarized, aes(x = num_counters, y = percent_follows_ME, fill = as.factor(pool_size))) +
  geom_bar(stat = "identity", position = position_dodge(), alpha = 0.75) + xlab("Number of counter examples") + ylab("Mutual exclusivity strength") + labs(fill="Pool size") +  scale_fill_manual(values=group.colors) +  geom_errorbar(aes(ymin=percent_follows_ME-percent_se, ymax=percent_follows_ME+percent_se), width=.2,
                 position=position_dodge(.9))
```

Original figure from Lake et al. (2019):

```{r, echo = FALSE, out.width = "500px"}
knitr::include_graphics(here("writeup/fig4_original_paper.png"))
```

##### Logistic mixed model:

```{r, include=TRUE, message=FALSE}
model_fit <- glmer(follows_ME ~ pool_size + num_counters + (1 | pid), data = df_ME,  family = binomial)
summary(model_fit)
```


#### Iconic Concatenation: 

```{r, include=TRUE, message=FALSE}
df_concat_summarize = df_concat %>%  group_by(pid) %>% summarize(percent_follows_iconicConcat = mean(follows_iconicConcat)*100)


ggplot(df_concat, aes(x=follows_iconicConcat, color=type)) +
  geom_histogram() + xlab("Follows Iconic Concatenation") + ylab("Count") + 
  scale_color_manual(labels = c("Study:dax⚫,lug🔵.Test: lug dax dax", "Study:dax⚫⚫⚫,lug🔵🔵.Test: dax lug", "Study: dax⚫,lug🔵.Test: dax lug"), values=c("blue", "red", "lightgreen"))
```
Iconic concatenation strength (across three trials):

```{r}
paste0(mean(df_concat_summarize$percent_follows_iconicConcat), "%")
```

Iconic concatenation strength in original paper: 93.9% (across three trials, 62/66 responses)

#### Mutual Exclusivity vs. One-to-One: 

```{r, include=TRUE, message=FALSE}
ggplot(df_ME_vs_OneToOne, aes(x=follows_1to1*100, color=type)) +
  geom_histogram() + xlab("Follows 1-to-1") + ylab("Count") + 
  scale_color_manual(labels = c("Study:dax⚫,lug🟡.Test: dax wif lug", "Study:dax⚫,lug🟡.Test: dax wif", "Study:dax⚫,lug🟡.Test: wif"), values=c("blue", "red", "lightgreen"))
```

Mutual exclusivity over one-to-one strength (across three trials):

```{r}
paste0(mean(df_ME_vs_OneToOne$follows_1to1)*100, "%")
```

One-to-one over mutual exclusivity strength in original paper: 50% (across three trials, 33/66 responses)


### Exploratory analysis: Simplest ME condition (pool size = 2, no counter evidence):

```{r}
df_ME_simplest_condition = df_ME %>% filter(pool_size == 2, num_counters == 0)
```

Response is single circle of another color (compared to color provided in study instructions):

```{r}
paste0(nrow(df_ME_simplest_condition %>% filter(follows_ME_simple_definition == 1)), "/", nrow(df_ME_simplest_condition)," participants: ", nrow(df_ME_simplest_condition %>% filter(follows_ME_simple_definition == 1))*100/nrow(df_ME_simplest_condition), "%")
```

Response is any sequence not similar to the colored circle provided in the study instructions:

```{r}
paste0(nrow(df_ME_simplest_condition %>% filter(follows_ME == 1)), "/", nrow(df_ME_simplest_condition)," participants: ", nrow(df_ME_simplest_condition %>% filter(follows_ME == 1))*100/nrow(df_ME_simplest_condition), "%")
```

In original paper: 18/22 (81.8%) and 20/22 (90.9%), respectively.


<!-- ### Exploratory analyses -->

<!-- Any follow-up analyses desired (not required). -->

<!-- ## Discussion -->

<!-- ### Summary of Replication Attempt -->

<!-- Open the discussion section with a paragraph summarizing the primary result from the confirmatory analysis and the assessment of whether it replicated, partially replicated, or failed to replicate the original result. -->

<!-- ### Commentary -->

<!-- Add open-ended commentary (if any) reflecting (a) insights from follow-up exploratory analysis, (b) assessment of the meaning of the replication (or not) - e.g., for a failure to replicate, are the differences between original and present study ones that definitely, plausibly, or are unlikely to have been moderators of the result, and (c) discussion of any objections or challenges raised by the current and original authors about the replication attempt. None of these need to be long. -->

## References

| Lake, B. M., & Baroni, M. (2023). Human-like systematic generalization through 
|     a meta-learning neural network. Nature, 623(7985), 115–121. 
|     https://doi.org/10.1038/s41586-023-06668-3 

| Lake, B. M., Linzen, T., & Baroni, M. (2019). Human few-shot learning of compositional instructions.
|     learning of compositional instructions. In A. K. Goel, C. M. Seifert, 
|     & C. Freksa (Eds.), proceedings of the 41st annual conference of the 
|     cognitive science society (pp. 611–617). Cognitive Science Society. 
|     Montreal, QB: Cognitive Science Society.